<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Duper Feeder - Documentation</title>
  <link rel="stylesheet" href="../styles.css">
</head>

<body>
  <header>
    <h1>Super Duper Feeder Documentation</h1>
    <p>Complete guide to using the WebSub/PubSubHubbub service</p>
  </header>

  <main>
    <section id="introduction">
      <h2>Introduction</h2>
      <p>
        Super Duper Feeder is a spec-compliant WebSub/PubSubHubbub service that allows users to subscribe to RSS feeds
        and get notified when new content is available. It provides real-time updates via WebSockets, Server-Sent Events
        (SSE), and webhooks.
      </p>
      <p>
        This documentation provides detailed information about the service's features, API endpoints, and usage
        examples.
      </p>
    </section>

    <section id="concepts">
      <h2>WebSub Concepts</h2>
      <p>
        WebSub (formerly PubSubHubbub) is a protocol that enables real-time notifications for content updates. It
        involves three main components:
      </p>
      <ul>
        <li><strong>Publishers</strong>: Content creators who notify the hub when they update their content</li>
        <li><strong>Hub</strong>: A server (like Super Duper Feeder) that receives update notifications from publishers
          and forwards them to subscribers</li>
        <li><strong>Subscribers</strong>: Services or applications that want to receive real-time updates about content
          changes</li>
      </ul>
      <p>
        The flow works as follows:
      </p>
      <ol>
        <li>A subscriber discovers the hub URL from a publisher's feed</li>
        <li>The subscriber sends a subscription request to the hub</li>
        <li>The hub verifies the subscription request with the subscriber</li>
        <li>When the publisher updates content, they notify the hub</li>
        <li>The hub fetches the updated content and sends it to all subscribers</li>
      </ol>
    </section>

    <section id="api-reference">
      <h2>API Reference</h2>

      <h3>WebSub Hub Endpoints</h3>
      <div class="endpoint">
        <h4>Main Hub Endpoint</h4>
        <p><code>POST /</code></p>
        <p>This endpoint handles both subscription and publishing operations.</p>

        <h5>For Publishers</h5>
        <p>To publish updates to the hub:</p>
        <pre><code>POST /
Content-Type: application/x-www-form-urlencoded

hub.mode=publish&hub.url=https://example.com/feed.xml</code></pre>

        <h5>For Subscribers</h5>
        <p>To subscribe to updates:</p>
        <pre><code>POST /
Content-Type: application/x-www-form-urlencoded

hub.callback=https://example.com/callback&hub.mode=subscribe&hub.topic=https://example.com/feed.xml&hub.lease_seconds=86400</code></pre>

        <p>To unsubscribe:</p>
        <pre><code>POST /
Content-Type: application/x-www-form-urlencoded

hub.callback=https://example.com/callback&hub.mode=unsubscribe&hub.topic=https://example.com/feed.xml</code></pre>
      </div>

      <h3>Firehose Endpoints</h3>
      <div class="endpoint">
        <h4>WebSocket Connection</h4>
        <p><code>GET /firehose/ws</code></p>
        <p>Establish a WebSocket connection for real-time updates.</p>
        <pre><code>const ws = new WebSocket('wss://superduperfeeder.deno.dev/firehose/ws');
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received update:', data);
};</code></pre>
      </div>

      <div class="endpoint">
        <h4>Server-Sent Events (SSE)</h4>
        <p><code>GET /firehose/sse</code></p>
        <p>Connect to the SSE endpoint for real-time updates.</p>
        <pre><code>const eventSource = new EventSource('https://superduperfeeder.deno.dev/firehose/sse');
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received update:', data);
};</code></pre>
      </div>

      <div class="endpoint">
        <h4>Webhook Registration</h4>
        <p><code>POST /firehose/webhook</code></p>
        <p>Register a webhook to receive updates via HTTP POST requests.</p>
        <pre><code>POST /firehose/webhook
Content-Type: application/json

{
  "url": "https://example.com/webhook",
  "contentType": "application/json",
  "filters": [
    {
      "type": "topic",
      "value": "https://example.com/feed.xml"
    }
  ]
}</code></pre>
      </div>

      <div class="endpoint">
        <h4>Webhook Deletion</h4>
        <p><code>DELETE /firehose/webhook/:id</code></p>
        <p>Remove a registered webhook.</p>
      </div>

      <div class="endpoint">
        <h4>List Webhooks</h4>
        <p><code>GET /firehose/webhook</code></p>
        <p>List all registered webhooks.</p>
      </div>

      <div class="endpoint">
        <h4>Health Check</h4>
        <p><code>GET /health</code></p>
        <p>Check if the service is running properly.</p>
      </div>
    </section>

    <section id="examples">
      <h2>Usage Examples</h2>

      <h3>Publishing Updates</h3>
      <p>
        When you update your content, notify the hub:
      </p>
      <pre><code>// Using fetch API in JavaScript
async function notifyHub(feedUrl) {
  const response = await fetch('https://superduperfeeder.deno.dev/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      'hub.mode': 'publish',
      'hub.url': feedUrl,
    }),
  });
  
  if (response.ok) {
    console.log('Hub notified successfully');
  } else {
    console.error('Failed to notify hub:', await response.text());
  }
}</code></pre>

      <h3>Subscribing to Updates</h3>
      <p>
        To subscribe to updates for a feed:
      </p>
      <pre><code>// Using fetch API in JavaScript
async function subscribe(callbackUrl, topicUrl, leaseSeconds = 86400) {
  const response = await fetch('https://superduperfeeder.deno.dev/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      'hub.callback': callbackUrl,
      'hub.mode': 'subscribe',
      'hub.topic': topicUrl,
      'hub.lease_seconds': leaseSeconds.toString(),
    }),
  });
  
  if (response.ok) {
    console.log('Subscription request sent successfully');
  } else {
    console.error('Failed to send subscription request:', await response.text());
  }
}</code></pre>

      <h3>Handling WebSub Verification</h3>
      <p>
        When the hub verifies a subscription, it sends a GET request to your callback URL:
      </p>
      <pre><code>// Example using Express.js
app.get('/callback', (req, res) => {
  const mode = req.query['hub.mode'];
  const topic = req.query['hub.topic'];
  const challenge = req.query['hub.challenge'];
  const leaseSeconds = req.query['hub.lease_seconds'];
  
  if (mode === 'subscribe' || mode === 'unsubscribe') {
    // Verify that this subscription/unsubscription is expected
    // If it is, respond with the challenge
    res.send(challenge);
  } else {
    res.status(400).send('Invalid request');
  }
});</code></pre>

      <h3>Receiving Updates</h3>
      <p>
        When the hub sends updates to your callback URL:
      </p>
      <pre><code>// Example using Express.js
app.post('/callback', express.raw({ type: 'application/atom+xml' }), (req, res) => {
  const contentType = req.headers['content-type'];
  const body = req.body.toString();
  
  // Process the update (body contains the updated feed content)
  console.log('Received update:', body);
  
  // Acknowledge receipt
  res.status(200).end();
});</code></pre>
    </section>

    <section id="best-practices">
      <h2>Best Practices</h2>
      <ul>
        <li>Always verify subscription requests to prevent spam</li>
        <li>Implement proper error handling for all API calls</li>
        <li>Use appropriate lease times for subscriptions (typically 1-7 days)</li>
        <li>Implement retry logic for failed webhook deliveries</li>
        <li>Consider using WebSockets or SSE for real-time applications</li>
        <li>Ensure your callback endpoint responds quickly to hub requests</li>
      </ul>
    </section>

    <section id="troubleshooting">
      <h2>Troubleshooting</h2>
      <h3>Common Issues</h3>
      <ul>
        <li>
          <strong>Subscription verification fails</strong>
          <p>Ensure your callback URL is publicly accessible and responds correctly to verification requests.</p>
        </li>
        <li>
          <strong>Not receiving updates</strong>
          <p>Check that your subscription is active and that your callback endpoint is functioning properly.</p>
        </li>
        <li>
          <strong>WebSocket connection drops</strong>
          <p>Implement reconnection logic with exponential backoff.</p>
        </li>
      </ul>
    </section>
  </main>

  <footer>
    <p>Super Duper Feeder - A WebSub/PubSubHubbub service</p>
    <p><a href="/">Back to Home</a></p>
  </footer>
</body>

</html>